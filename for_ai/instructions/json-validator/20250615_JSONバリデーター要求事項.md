# やりたいこと

指定されたJSONオブジェクトが、本プロジェクトのschema配下で管理されるJSONスキーマを満たしているかどうかを検証するバリデーターを実装する。

# 技術スタック

- 言語: Python(3.9以上)
- ライブラリ
    - jsonschema(4.24以上)

# 要求定義

## 前処理

### インデックス作成

#### file_type_map : Map[file_type, JSONスキーマへのパス]

`schema`配下の全ての.schema.jsonファイルの"file_type"属性の値から、JSONスキーマファイルへのパスを事前に生成する。

!!! Warning
    記載中

#### object_type_map : Map[object_type, JSONスキーマへのパス]

`schema`配下の全ての.schema.jsonファイルの"object_type"属性の値から、JSONスキーマファイルへのパスを事前に生成する。

!!! Warning
    記載中

#### RefResolver : Map[$id, JSONスキーマ]

`schema`配下の全ての.schema.jsonファイルの"$ref"属性の値から、JSONスキーマへのマッピングを事前に生成する。<br>
マッピングは、jsonschemaのRefResolverとして登録する。

!!! Warning
    記載中
        - 例: "$ref":"https://jocf.startupstandard.org/jocf/main/schema/objects/transactions/issuance/StockIssuance.schema.json"が設定されている場合、許可スキーマは `main/schema/objects/transactions/issuance/StockIssuance.schema.json` である

## 検証の手続き

-----
### ファイル検証

**入力**:
    - 「ファイルオブジェクト」:JSONオブジェクト:必須
**出力**: 検証結果

1. 「検証スキーマ」の特定
    - ${ファイルオブジェクト}の"file_type"属性を参照し、値を元に `schema/files`配下の.schema.jsonファイルから、同じ"file_type"属性と値を持つスキーマ =「検証スキーマ」を特定
        - ${ファイルオブジェクト}に"file_type"属性が存在しない場合は検証失敗
        - 検証スキーマの特定は、前処理で生成されている${file_type_map}を利用する
        - "file_type"属性に指定された値に一致する.schema.jsonファイルが存在しない場合は検証失敗
    - 例: "file_type":"JOCF_TRANSACTIONS_FILE"が設定されている場合、検証スキーマは`schema/files/TransactionsFile.schema.json`となる
2. 必須属性チェック
    - ${検証スキーマ}の"required"属性で指定された属性が、${ファイルオブジェクト}に定義されているかどうかをチェック
    - 必須にも関わらず未定義の属性があれば検証失敗
3. "items"配列の型チェック
    - ${ファイルオブジェクト}に、"items"配列が定義されていない場合は検証失敗
    - ${ファイルオブジェクト}の"items"配列を参照、配列に含まれる各要素のJSONオブジェクトから"object_type"を抽出する(抽出した一覧を「ファイルオブジェクト.object_type_list」とする)
        - "object_type"属性を持たない要素が存在する場合は検証失敗
    - ${検証スキーマ}の"properties.items.(略).oneOf"属性を参照、検証スキーマで許可されているJSONスキーマ(以下、「許可スキーマ」)を特定し、当該スキーマの"object_type"を抽出する(抽出した一覧を「許可スキーマ.object_type_list」とする)
        - 許可スキーマの特定は、事前に生成されている${RefResolver}を利用する
    - ${ファイルオブジェクト.object_type_list} ⊆ ${許可スキーマ.object_type_list}であれば検証成功、そうで無ければ検証失敗
4. "items"配列の各要素の検証
    - ${ファイルオブジェクト}の"items"配列を参照、配列に含まれる各要素のJSONオブジェクトを入力として「オブジェクト検証」を実施する
5. その他属性の検証
    - "file_type", "items"以外の全ての属性について、${検証スキーマ}に従ってバリデーションを実施
    - 検証対象の属性がJSONオブジェクトかつ"object_type"が設定されている場合は、当該属性のJSONオブジェクトを入力として「オブジェクト検証」を実施する
6. 結果をリターン
    - 全ての検証が成功したら検証成功、一部でも失敗したら検証失敗
    - 検証失敗の場合は、失敗の理由を出力すること

-----
### オブジェクト検証

**入力**:
    - 「オブジェクトデータ」:JSONオブジェクト:必須
**出力**: 検証結果

1. ${オブジェクトデータ}の"object_type"属性を参照、 `schema`配下の.schema.jsonファイルから、同じ"object_type"属性と値を持つ.schema.jsonファイル=「検証スキーマ」を特定
    - ${オブジェクトデータ}に"object_type"が定義されていない場合は検証失敗
    - 検証スキーマの特定は、事前に生成されている${object_type_map}を利用する
2. 全属性検証
    - ${オブジェクトデータ}が${検証スキーマ}に合致しているかを確認
    - jsonschema.validateを使う
        - jsonschemaは$refやoneOf, allOfなど`JSONSchema Draft 4/7/2019-09/2020-12`を完全サポート 
        - 前処理でRefResolverが準備することで、$refも適切に解決され、オブジェクトのネストも含めて検証される
3. 結果をリターン

